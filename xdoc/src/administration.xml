<?xml version="1.0" encoding="UTF-8"?>
<chapter id="administration">
<title>Administration</title>

<section>
	<title>Entity Relationship Model</title>
	
	<section>
		<title>Graphical overview of tables</title>
		<para><graphic fileref="images/schema.png"/></para>
	</section>
	
	<section>
		<title>Tables in Hedwig</title>
		<para>This is a more detailed description of the tables in hedwig in alphabetic order.</para>
		
		<section>
			<title>acl</title>
			<para>Defines Access Control List for shared mailboxes. IMAP4 ACL extension is defined in RFC 2086.</para>
			<para>
				<table>
					<title>acl</title>
					<tgroup cols="3">
						<thead>
							<row>
								<entry>Attribute</entry>
								<entry>Data Type</entry>
								<entry>Description</entry>
							</row>
						</thead>
						<tbody>
							<row>
								<entry>user_id</entry>
								<entry>BIGINT</entry>
								<entry>First primary key and foreign key referencing user.id.</entry>
							</row>
							<row>
								<entry>mailboxid</entry>
								<entry>BIGINT</entry>
								<entry>Second primary key and foreign key referencing mailbox.mailboxid.</entry>
							</row>
							<row>
								<entry>lookup</entry>
								<entry>CHAR</entry>
								<entry>Mailbox is visible to LIST/LSUB commands, SUBSCRIBE mailbox.</entry>
							</row>
							<row>
								<entry>read</entry>
								<entry>CHAR</entry>
								<entry>SELECT the mailbox, perform STATUS.</entry>
							</row>
							<row>
								<entry>seen</entry>
								<entry>CHAR</entry>
								<entry>Set or clear \SEEN flag via STORE, also set them during APPEND/COPY.</entry>
							</row>
							<row>
								<entry>write</entry>
								<entry>CHAR</entry>
								<entry>Set or clear other than \SEEN and \DELETED via STORE, also set them during APPEND/COPY.</entry>
							</row>
							<row>
								<entry>insert</entry>
								<entry>CHAR</entry>
								<entry>Perform APPEND, COPY into mailbox.</entry>
							</row>
							<row>
								<entry>post</entry>
								<entry>CHAR</entry>
								<entry>Send mail to submission address for mailbox.</entry>
							</row>
							<row>
								<entry>create</entry>
								<entry>CHAR</entry>
								<entry>CREATE new sub-mailboxes in any implementation-defined hierarchy, parent mailbox for the new mailbox name in RENAME.</entry>
							</row>
							<row>
								<entry>delete</entry>
								<entry>CHAR</entry>
								<entry>DELETE mailbox, old mailbox name in RENAME.</entry>
							</row>
							<row>
								<entry>deletemsg</entry>
								<entry>CHAR</entry>
								<entry>Set or clear other than \DELETED flag via STORE, also set them during APPEND/COPY.</entry>
							</row>
							<row>
								<entry>expunge</entry>
								<entry>CHAR</entry>
								<entry>Perform EXPUNGE and expunge as a part of CLOSE.</entry>
							</row>
							<row>
								<entry>admin</entry>
								<entry>CHAR</entry>
								<entry>Perform SETACL/DELETEACL/GETACL/LISTRIGHTS.</entry>
							</row>
						</tbody>
					</tgroup>
				</table>
			</para>
		</section>

		<section>
			<title>alias</title>
			<para>Defines the mailrouting address for specific mail address.</para>
			<para>
				<table>
					<title>alias</title>
					<tgroup cols="3">
						<thead>
							<row>
								<entry>Attribute</entry>
								<entry>Data Type</entry>
								<entry>Description</entry>
							</row>
						</thead>
						<tbody>
							<row>
								<entry>id</entry>
								<entry>BIGINT</entry>
								<entry>Primary key.</entry>
							</row>
							<row>
								<entry>user_id</entry>
								<entry>BIGINT</entry>
								<entry>Foreign key referencing user.id.</entry>
							</row>
							<row>
								<entry>alias</entry>
								<entry>VARCHAR(100)</entry>
								<entry>Destination by MDA.</entry>
							</row>
						</tbody>
					</tgroup>
				</table>
			</para>
		</section>

		<section>
			<title>headername</title>
			<para>Message header names referenced by headervalue table.</para>
			<para>
				<table>
					<title>headername</title>
					<tgroup cols="3">
						<thead>
							<row>
								<entry>Attribute</entry>
								<entry>Data Type</entry>
								<entry>Description</entry>
							</row>
						</thead>
						<tbody>
							<row>
								<entry>id</entry>
								<entry>BIGINT</entry>
								<entry>Primary key.</entry>
							</row>
							<row>
								<entry>headername</entry>
								<entry>VARCHAR(100)</entry>
								<entry>Header name.</entry>
							</row>
						</tbody>
					</tgroup>
				</table>
			</para>
		</section>

		<section>
			<title>headervalue</title>
			<para>Message header values stored in each raw e-mail.</para>
			<para>
				<table>
					<title>headervalue</title>
					<tgroup cols="3">
						<thead>
							<row>
								<entry>Attribute</entry>
								<entry>Data Type</entry>
								<entry>Description</entry>
							</row>
						</thead>
						<tbody>
							<row>
								<entry>id</entry>
								<entry>BIGINT</entry>
								<entry>Primary key.</entry>
							</row>
							<row>
								<entry>physmessageid</entry>
								<entry>BIGINT</entry>
								<entry>Foreign key referencing physmessage.id.</entry>
							</row>
							<row>
								<entry>headernameid</entry>
								<entry>BIGINT</entry>
								<entry>Foreign key referencing headername.id.</entry>
							</row>
							<row>
								<entry>headervalue</entry>
								<entry>TEXT</entry>
								<entry>Header value.</entry>
							</row>
						</tbody>
					</tgroup>
				</table>
			</para>
		</section>

		<section>
			<title>keyword</title>
			<para>User flags for each messages are stored in this table.</para>
			<para>
				<table>
					<title>keyword</title>
					<tgroup cols="3">
						<thead>
							<row>
								<entry>Attribute</entry>
								<entry>Data Type</entry>
								<entry>Description</entry>
							</row>
						</thead>
						<tbody>
							<row>
								<entry>messageid</entry>
								<entry>BIGINT</entry>
								<entry>Primary key and foreign key referencing message.messageid.</entry>
							</row>
							<row>
								<entry>keyword</entry>
								<entry>VARCHAR(255)</entry>
								<entry>Keyword of the message.</entry>
							</row>
						</tbody>
					</tgroup>
				</table>
			</para>
		</section>

		<section>
			<title>mailbox</title>
			<para>Mailbox information is stored in this table.</para>
			<para>
				<table>
					<title>mailbox</title>
					<tgroup cols="3">
						<thead>
							<row>
								<entry>Attribute</entry>
								<entry>Data Type</entry>
								<entry>Description</entry>
							</row>
						</thead>
						<tbody>
							<row>
								<entry>mailboxid</entry>
								<entry>BIGINT</entry>
								<entry>Primary key.</entry>
							</row>
							<row>
								<entry>ownerid</entry>
								<entry>BIGINT</entry>
								<entry>Foreign key referencing user.id.</entry>
							</row>
							<row>
								<entry>name</entry>
								<entry>VARCHAR(255)</entry>
								<entry>Name of mailbox including the hierarchy information.</entry>
							</row>
							<row>
								<entry>noinferiors</entry>
								<entry>CHAR</entry>
								<entry>No child levels under this mailbox possible.</entry>
							</row>
							<row>
								<entry>noselect</entry>
								<entry>CHAR</entry>
								<entry>Not possible to use this mailbox as selectable mailbox.</entry>
							</row>
							<row>
								<entry>readonly</entry>
								<entry>CHAR</entry>
								<entry>READ-ONLY or READ-WRITE.</entry>
							</row>
							<row>
								<entry>nextuid</entry>
								<entry>BIGINT</entry>
								<entry>The next unique indentifier for the message which will be stored in this mailbox.</entry>
							</row>
							<row>
								<entry>uidvalidity</entry>
								<entry>BIGINT</entry>
								<entry>The unique indentifier validity value for this mailbox.</entry>
							</row>
						</tbody>
					</tgroup>
				</table>
			</para>
		</section>

		<section>
			<title>message</title>
			<para>Message information for each mailboxes. IMAP system flags for each messages as defined in RFC 3501.</para>
			<para>
				<table>
					<title>message</title>
					<tgroup cols="3">
						<thead>
							<row>
								<entry>Attribute</entry>
								<entry>Data Type</entry>
								<entry>Description</entry>
							</row>
						</thead>
						<tbody>
							<row>
								<entry>messageid</entry>
								<entry>BIGINT</entry>
								<entry>Primary key.</entry>
							</row>
							<row>
								<entry>mailboxid</entry>
								<entry>BIGINT</entry>
								<entry>Foreign key referencing mailbox.mailboxid.</entry>
							</row>
							<row>
								<entry>physmessageid</entry>
								<entry>BIGINT</entry>
								<entry>Foreign key referencing physmessage.id.</entry>
							</row>
							<row>
								<entry>seen</entry>
								<entry>CHAR</entry>
								<entry>Message has been read.</entry>
							</row>
							<row>
								<entry>answered</entry>
								<entry>CHAR</entry>
								<entry>Message has been answered.</entry>
							</row>
							<row>
								<entry>deleted</entry>
								<entry>CHAR</entry>
								<entry>Message is deleted for removal by later EXPUNGE.</entry>
							</row>
							<row>
								<entry>flagged</entry>
								<entry>CHAR</entry>
								<entry>Message is flagged for urgent or special attention.</entry>
							</row>
							<row>
								<entry>recent</entry>
								<entry>CHAR</entry>
								<entry>Message recently arrived in this mailbox.</entry>
							</row>
							<row>
								<entry>draft</entry>
								<entry>CHAR</entry>
								<entry>Message has not completed composition.</entry>
							</row>
						</tbody>
					</tgroup>
				</table>
			</para>
		</section>

		<section>
			<title>physmessage</title>
			<para>Mapping table for message and raw e-mail message stored in file system.</para>
			<para>
				<table>
					<title>physmessage</title>
					<tgroup cols="3">
						<thead>
							<row>
								<entry>Attribute</entry>
								<entry>Data Type</entry>
								<entry>Description</entry>
							</row>
						</thead>
						<tbody>
							<row>
								<entry>id</entry>
								<entry>BIGINT</entry>
								<entry>Primary key.</entry>
							</row>
							<row>
								<entry>size</entry>
								<entry>BIGINT</entry>
								<entry>Raw mail size.</entry>
							</row>
							<row>
								<entry>internaldate</entry>
								<entry>DATETIME</entry>
								<entry>Internal Date Message Attribute.</entry>
							</row>
							<row>
								<entry>subject</entry>
								<entry>VARCHAR(255)</entry>
								<entry>Envelope structure's SUBJECT field string.</entry>
							</row>
							<row>
								<entry>sentdate</entry>
								<entry>DATETIME</entry>
								<entry>RFC-2822 Date: header value.</entry>
							</row>
							<row>
								<entry>fromaddr</entry>
								<entry>VARCHAR(100)</entry>
								<entry>Envelope structure's FROM field.</entry>
							</row>
						</tbody>
					</tgroup>
				</table>
			</para>
		</section>

		<section>
			<title>subscription</title>
			<para>Subscribed mailboxes of a user returned by LSUB command.</para>
			<para>
				<table>
					<title>subscription</title>
					<tgroup cols="3">
						<thead>
							<row>
								<entry>Attribute</entry>
								<entry>Data Type</entry>
								<entry>Description</entry>
							</row>
						</thead>
						<tbody>
							<row>
								<entry>userid</entry>
								<entry>BIGINT</entry>
								<entry>First part of unique key and foreign key referencing user.id.</entry>
							</row>
							<row>
								<entry>mailboxid</entry>
								<entry>BIGINT</entry>
								<entry>Second part of unique key and foreign key referencing mailbox.mailboxid.</entry>
							</row>
						</tbody>
					</tgroup>
				</table>
			</para>
		</section>

		<section>
			<title>user</title>
			<para>User table.</para>
			<para>
				<table>
					<title>user</title>
					<tgroup cols="3">
						<thead>
							<row>
								<entry>Attribute</entry>
								<entry>Data Type</entry>
								<entry>Description</entry>
							</row>
						</thead>
						<tbody>
							<row>
								<entry>id</entry>
								<entry>BIGINT</entry>
								<entry>Primary key.</entry>
							</row>
							<row>
								<entry>userid</entry>
								<entry>VARCHAR(100)</entry>
								<entry>E-mail address for the user.</entry>
							</row>
							<row>
								<entry>passwd</entry>
								<entry>VARCHAR(34)</entry>
								<entry>Login password of the user.</entry>
							</row>
							<row>
								<entry>maxmail_size</entry>
								<entry>BIGINT</entry>
								<entry>RFC 2087 IMAP4 QUOTA extension.</entry>
							</row>
							<row>
								<entry>forward</entry>
								<entry>VARCHAR(100)</entry>
								<entry>The mail address to which this user's email is forwarded.</entry>
							</row>
						</tbody>
					</tgroup>
				</table>
			</para>
		</section>

	</section>
</section>

<section>
	<title>Directory Structure</title>
	<para>
Installing the Hedwig distribution creates a hedwig-{version} directory that contains server start scripts, 
JARs, server configuration sets, SQL scripts and working and data directories.	
	</para>
	<para>
		<table>
			<title>The Hedwig server top-loevel directory structure</title>
			<tgroup cols="2">
				<thead>
					<row>
						<entry>Directory</entry>
						<entry>Description</entry>
					</row>
				</thead>
				<tbody>
					<row>
						<entry>bin</entry>
						<entry>Start and delivery scripts are located in the bin directory.</entry>
					</row>
					<row>
						<entry>conf</entry>
						<entry>The conf directory contains the applicationContext.xml and default.properties file for server configuration.</entry>
					</row>
					<row>
						<entry>data</entry>
						<entry>
The data directory contains all the message files delivered to this server.
Message files are stored in sub directories that are dynamically created according to the date of transmission.
These sub directories look like this: 
							<para>
data/mail/YYYY/MM/DD/XX
							</para>
where XX is modular for the physical message ID of the message file. 
						</entry>
					</row>
					<row>
						<entry>lib</entry>
						<entry>The lib directory contains all Java libraries used by Hedwig.</entry>
					</row>
					<row>
						<entry>spool</entry>
						<entry>The spool directory contains spooled messages stored by SMTP server.</entry>
					</row>
					<row>
						<entry>sql</entry>
						<entry>The sql directory contains SQL scripts creating database structure.</entry>
					</row>
					<row>
						<entry>temp</entry>
						<entry>
The tmp directory is used by LDA to store temporarily message files which was not assigned physical message identifier.
These files will be moved to the data directory after server assigns physical message identifier.
						</entry>
					</row>
				</tbody>
			</tgroup>
		</table>
	</para>
</section>

<section id="diskcleanup">
	<title>Disk Cleanup Cron</title>
	<para>
The Disk Cleanup cron helps you free up space on mail server's hard disk by searching for messages and message files that can be deleted or compressed.
	</para>
	<section>
		<title>Target Categories in Disk Cleanup Cron</title>
		<para>
There are two different types of categories that Disk Cleanup targets when it performs the job.
			<variablelist>
				<varlistentry>
					<term>Expunge Old Messages and Message Files</term>
					<listitem>
						<para>
It expunges messages and message files that are stored in specfic mailbox and older than specific period of time from now.
You can specify the mailboxes and periods by setting the <emphasis>expunge_after</emphasis> parameter in default.<emphasis>properties</emphasis>.
This parameter is consist of pairs of mailbox name and period. 
						</para>
					</listitem>
				</varlistentry>
				<varlistentry>
					<term>Compress Old Message Files</term>
					<listitem>
						<para>
It compresses message files that are older than specific period of time from now.
The files are still available, but there will be a slight increase in access times because the files will be decompressed every time they are accessed.
You can specify the period by setting the <emphasis>compress_after</emphasis> parameter in default.<emphasis>properties</emphasis>.
						</para>
					</listitem>
				</varlistentry>
			</variablelist>
		</para>
	</section>
	<section>
		<title>Schedule Disk Cleanup</title>
		<para>
You might want to set the cron to run daily or weekly depending on what works best for you.
To schedule Disk Cleanup Cron to run on a regular basis we need to edit the <emphasis>applicationContext.xml</emphasis> from <emphasis>conf</emphasis> directory of your installation.
Change the <emphasis>cronExpression</emphasis> to what you want to.
<screen><![CDATA[
	<bean id="cronTrigger" class="org.springframework.scheduling.quartz.CronTriggerBean">
		<property name="jobDetail" ref="diskCleanupJob" />
		<!-- Run every day at 3 AM -->
		<property name="cronExpression" value="0 0 3 * * ?" />
	</bean>
]]></screen>
The <emphasis>cronExpression</emphasis> is a string that is actually made up of seven sub-expressions, that descibe individual details of the schedule. 
These sub-expression are separated with white-space, and represents:
<orderedlist>
	<listitem><para>Seconds</para></listitem>
	<listitem><para>Minutes</para></listitem>
	<listitem><para>Hours</para></listitem>
	<listitem><para>Day-of-Month</para></listitem>
	<listitem><para>Month</para></listitem>
	<listitem><para>Day-of-Week</para></listitem>
	<listitem><para>Year (optional field)</para></listitem>
</orderedlist>
See the <ulink url="http://www.quartz-scheduler.org/docs/tutorial/TutorialLesson06.html">Quartz Enterprise Job Scheduler Tutorial</ulink> for more information about cron expression.
		</para>
	</section>
	<para>
	</para>
</section>

</chapter>
